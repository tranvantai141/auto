---
stages:
- sonarcloud-check


.sonar: &sonar-template
  stage: sonarcloud-check
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    CI_DEBUG_TRACE: "true"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  before_script:
    - |
      export SONAR_PROJECT_ID="$(echo "${CI_PROJECT_NAMESPACE}" | tr '[:upper:]' '[:lower:]' | sed "s|\/|:|g"):$(echo "${CI_PROJECT_NAME}" | tr '[:upper:]' '[:lower:]')-key-${CI_PROJECT_ID}"
      export SONAR_PROJECT_NAME="$(echo "${CI_PROJECT_NAMESPACE}" | tr '[:lower:]' '[:upper:]' | sed "s|-| |g")/$(echo "${CI_PROJECT_NAME}" | sed "s|-| |g" | tr '[:lower:]' '[:upper:]')"
  script:
#    - sonar-scanner -Dsonar.qualitygate.wait=true -Dsonar.projectKey="${SONAR_PROJECT_ID}" -Dsonar.projectName="${SONAR_PROJECT_NAME}" -Dsonar.projectCreation.mainBranchName="${CI_DEFAULT_BRANCH}" -Dsonar.host.url="${SONAR_HOST_URL}" -Dsonar.host.url="${SONAR_HOST_URL}" -Dsonar.log.level=DEBUG -Dsonar.verbose=true
    - sonar-scanner  -Dsonar.projectKey="${SONAR_PROJECT_ID}" -Dsonar.projectName="${SONAR_PROJECT_NAME}" -Dsonar.projectCreation.mainBranchName="${CI_DEFAULT_BRANCH}" -Dsonar.host.url="${SONAR_HOST_URL}" -Dsonar.host.url="${SONAR_HOST_URL}" -Dsonar.log.level=DEBUG -Dsonar.verbose=true
  allow_failure: true
  tags:
    - sit
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(main|develop|hotfix|release).*$/'
      when: always
  artifacts:
    paths:
      - .scannerwork/report-task.txt
      
sonarcloud-check:
  <<: *sonar-template


#---
#stages:
#- sonarcloud-check
#
#variables:
#  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
#  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
#
#sonarcloud-check:
#  stage: sonarcloud-check
#  image:
#    name: sonarsource/sonar-scanner-cli:latest
#    entrypoint: [""]
#  cache:
#    key: "${CI_JOB_NAME}"
#    paths:
#      - .sonar/cache
#  tags:
#  - sit
#  script:
#    - sonar-scanner
#  only:
#    - main
#    - develop
